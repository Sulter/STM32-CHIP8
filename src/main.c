#include <libopencm3/stm32/rcc.h>
#include <stdio.h>
#include "pcd8544.h"
#include "timer.h"
#include "usb_cdc.h"
#include "chip8.h"
#include "rng.h"

void setup(void);
void loop(void);
void set_pixel_test(void);
void chip8_loop(void);
void chip8_draw(void);
void chip8_set_keys(void);

Timer chip8_loop_timer, chip8_timers_timer;
//uint8_t chip8ROM[] = {0xC0, 0x1f, 0xA0, 0x32, 0xD1, 0x05};
uint8_t chip8ROM[] = {
  0x6a, 0x02, 0x6b, 0x0c, 0x6c, 0x3f, 0x6d, 0x0c, 0xa2, 0xea, 0xda, 0xb6,
  0xdc, 0xd6, 0x6e, 0x00, 0x22, 0xd4, 0x66, 0x03, 0x68, 0x02, 0x60, 0x60,
  0xf0, 0x15, 0xf0, 0x07, 0x30, 0x00, 0x12, 0x1a, 0xc7, 0x17, 0x77, 0x08,
  0x69, 0xff, 0xa2, 0xf0, 0xd6, 0x71, 0xa2, 0xea, 0xda, 0xb6, 0xdc, 0xd6,
  0x60, 0x01, 0xe0, 0xa1, 0x7b, 0xfe, 0x60, 0x04, 0xe0, 0xa1, 0x7b, 0x02,
  0x60, 0x1f, 0x8b, 0x02, 0xda, 0xb6, 0x60, 0x0c, 0xe0, 0xa1, 0x7d, 0xfe,
  0x60, 0x0d, 0xe0, 0xa1, 0x7d, 0x02, 0x60, 0x1f, 0x8d, 0x02, 0xdc, 0xd6,
  0xa2, 0xf0, 0xd6, 0x71, 0x86, 0x84, 0x87, 0x94, 0x60, 0x3f, 0x86, 0x02,
  0x61, 0x1f, 0x87, 0x12, 0x46, 0x02, 0x12, 0x78, 0x46, 0x3f, 0x12, 0x82,
  0x47, 0x1f, 0x69, 0xff, 0x47, 0x00, 0x69, 0x01, 0xd6, 0x71, 0x12, 0x2a,
  0x68, 0x02, 0x63, 0x01, 0x80, 0x70, 0x80, 0xb5, 0x12, 0x8a, 0x68, 0xfe,
  0x63, 0x0a, 0x80, 0x70, 0x80, 0xd5, 0x3f, 0x01, 0x12, 0xa2, 0x61, 0x02,
  0x80, 0x15, 0x3f, 0x01, 0x12, 0xba, 0x80, 0x15, 0x3f, 0x01, 0x12, 0xc8,
  0x80, 0x15, 0x3f, 0x01, 0x12, 0xc2, 0x60, 0x20, 0xf0, 0x18, 0x22, 0xd4,
  0x8e, 0x34, 0x22, 0xd4, 0x66, 0x3e, 0x33, 0x01, 0x66, 0x03, 0x68, 0xfe,
  0x33, 0x01, 0x68, 0x02, 0x12, 0x16, 0x79, 0xff, 0x49, 0xfe, 0x69, 0xff,
  0x12, 0xc8, 0x79, 0x01, 0x49, 0x02, 0x69, 0x01, 0x60, 0x04, 0xf0, 0x18,
  0x76, 0x01, 0x46, 0x40, 0x76, 0xfe, 0x12, 0x6c, 0xa2, 0xf2, 0xfe, 0x33,
  0xf2, 0x65, 0xf1, 0x29, 0x64, 0x14, 0x65, 0x00, 0xd4, 0x55, 0x74, 0x15,
  0xf2, 0x29, 0xd4, 0x55, 0x00, 0xee, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00
};
unsigned int chip8ROM_len = 246;

int main(void)
{
    setup();

    for(;;) {
	loop();
    }

    return 0;
}

void setup(void)
{
    /*
      The main PLL will run at 168 MHz, APB1 at 42, APB2 at 84 MHz.
     */
    rcc_clock_setup_hse_3v3(&rcc_hse_8mhz_3v3[RCC_CLOCK_3V3_168MHZ]);

    //init individual drivers/modules
    rng_enable();
    LcdInitialise();
    TimerInit(168000000);
    usb_init();
    chip8_init(chip8ROM, chip8ROM_len);

    //init timers
    chip8_loop_timer.millisInterrupt = 1;
    chip8_loop_timer.timerCallback = chip8_loop;
    TimerAdd(&chip8_loop_timer, 1);

    chip8_timers_timer.millisInterrupt = 170; //~6Hz
    chip8_timers_timer.timerCallback = chip8_timer_ISR;
    TimerAdd(&chip8_timers_timer, 2);
}

void chip8_loop(void)
{
    chip8_set_keys();

    chip8_step();

    chip8_draw();
}

void chip8_set_keys(void)
{
    char buf[64];
    uint8_t len = usb_get(buf);
    if(len) {
	switch (buf[0]) {
	    case '1':
		chip8_set_key(k_0, true);
		break;
	    case '2':
		chip8_set_key(k_1, true);
		break;
	    case '3':
		chip8_set_key(k_2, true);
		break;
	    case '4':
		chip8_set_key(k_3, true);
		break;
	    case 'q':
		chip8_set_key(k_4, true);
		break;
	    case 'w':
		chip8_set_key(k_5, true);
		break;
	    case 'e':
		chip8_set_key(k_6, true);
		break;
	    case 'r':
		chip8_set_key(k_7, true);
		break;
	    case 'a':
		chip8_set_key(k_8, true);
		break;
	    case 's':
		chip8_set_key(k_9, true);
		break;
	    case 'd':
		chip8_set_key(k_a, true);
		break;
	    case 'f':
		chip8_set_key(k_b, true);
		break;
	    case 'z':
		chip8_set_key(k_c, true);
		break;
	    case 'x':
		chip8_set_key(k_d, true);
		break;
	    case 'c':
		chip8_set_key(k_e, true);
		break;
	    case 'v':
		chip8_set_key(k_f, true);
		break;
	    default:
		break;
	}
    }
}

void chip8_draw(void)
{
    chip8_screen_t chip8_screen_ptr;

    chip8_screen_ptr = chip8_get_screen_buffer();
    for(int x = 0; x < CHIP8_WIDTH; x++) {
	for(int y = 0; y < CHIP8_HEIGHT; y++) {
	    if(chip8_screen_ptr[x][y])
		LcdSetPixel(x, y);
	}
    }

    LcdFlipBuffer();
}

void set_pixel_test()
{
    static uint8_t x = 0;
    static uint8_t y = 0;

    LcdSetPixel(x, y);
    char buf[64];
    uint8_t len = usb_get(buf);
    if(len) {
	switch (buf[0]) {
	    case 'a':
		x--;
		break;
	    case 'w':
		y--;
		break;
	    case 's':
		y++;
		break;
	    case 'd':
		x++;
		printf("Moving in x++ direction\r\n");
		break;
	    default:
		break;
	}
    }

    LcdFlipBuffer();
}

void loop(void)
{
    usb_poll();
}
